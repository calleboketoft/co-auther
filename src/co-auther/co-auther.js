var dontTouchLocalStorage = false;
var terminalRoute = null;
var initialRequestFailed = false;
var coAuther;
function basicRouting(afterHash) {
    var loc = window.location;
    window.location.href = loc.protocol + "//" + loc.host + loc.pathname + "#/" + afterHash;
}
// Basic default route function, should be overridden
var routeFunction = function (afterHash) {
    basicRouting(afterHash);
};
var getCoAuther = function () {
    if (!coAuther) {
        throw 'CoAuther has not been initialized yet';
    }
    else {
        return coAuther;
    }
};
exports.getCoAuther = getCoAuther;
var config = {
    LOGGED_IN: 'loggedIn',
    AUTHENTICATE: 'authenticate',
    INITIAL_REQUEST: 'initialRequest',
    AUTH_DATA: 'authData'
};
// Determine if a route canActivate or not
var initialRequestPending = false;
function activationHelper(currentPage) {
    var canActivate = false;
    var destinationRoute = null;
    var authData = getCoAuther().getAuthData();
    var initialDataLoaded = getCoAuther().isInitialDataLoaded();
    if (authData && initialDataLoaded) {
        // authData and initialRequest done, you are logged in
        destinationRoute = config.LOGGED_IN;
        canActivate = currentPage === destinationRoute;
    }
    else if (!authData) {
        destinationRoute = config.AUTHENTICATE;
        canActivate = currentPage === destinationRoute;
    }
    else {
        destinationRoute = config.INITIAL_REQUEST;
        canActivate = currentPage === destinationRoute;
        if (!initialRequestPending && !initialRequestFailed) {
            initialRequestPending = true;
            getCoAuther().makeInitialRequestWrap()
                .then(function () {
                initialRequestPending = false;
                // initialRequest done, move on to logged in
                if (terminalRoute) {
                    return goToTerminal();
                }
                return routeFunction(config.LOGGED_IN);
            })
                .catch(function () {
                // initial request failed, clear auth data from login and go to authenticate
                initialRequestPending = false;
                initialRequestFailed = true;
                clearAuthData();
                return routeFunction(config.AUTHENTICATE);
            });
        }
        else if (initialRequestFailed && authData) {
            console.error('Initial request promise was rejected. You have manual authData management and need to clear authData from localStorage manually.');
        }
    }
    if (!canActivate) {
        return routeFunction(destinationRoute);
    }
    return canActivate;
}
exports.activationHelper = activationHelper;
// terminal memory
function setTerminal() {
    terminalRoute = window.location.hash.substring(2);
    return true;
}
exports.setTerminal = setTerminal;
function goToTerminal() {
    basicRouting(terminalRoute);
}
function CoAuther(apiService) {
    var initialDataLoaded = false;
    function isInitialDataLoaded() {
        return initialDataLoaded;
    }
    var initialRequestRes;
    function loginWrap() {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i - 0] = arguments[_i];
        }
        initialRequestFailed = false; // reset this one
        return apiService.login.apply(apiService, args)
            .then(function (res) {
            // authData has arrived, go make initial request
            setAuthData(res);
            routeFunction(config.INITIAL_REQUEST);
        });
    }
    function logoutWrap() {
        var args = [];
        for (var _i = 0; _i < arguments.length; _i++) {
            args[_i - 0] = arguments[_i];
        }
        return apiService.logout.apply(apiService, args)
            .then(function () {
            clearAuthData();
        });
    }
    function makeInitialRequestWrap() {
        return apiService.makeInitialRequest()
            .then(function (data) {
            // Flag for intial data
            initialDataLoaded = true;
        });
    }
    return {
        loginWrap: loginWrap,
        logoutWrap: logoutWrap,
        makeInitialRequestWrap: makeInitialRequestWrap,
        getAuthData: getAuthData,
        isInitialDataLoaded: isInitialDataLoaded
    };
}
function initialize(apiService, newConfig, newRouteFunction) {
    coAuther = CoAuther(apiService);
    if (newConfig.authData) {
        config.AUTH_DATA = newConfig.authData;
    }
    if (newConfig.dontTouchLocalStorage) {
        dontTouchLocalStorage = true;
    }
    if (newConfig.routes) {
        if (newConfig.routes.loggedIn) {
            config.LOGGED_IN = newConfig.routes.loggedIn;
        }
        if (newConfig.routes.authenticate) {
            config.AUTHENTICATE = newConfig.routes.authenticate;
        }
        if (newConfig.routes.initialRequest) {
            config.INITIAL_REQUEST = newConfig.routes.initialRequest;
        }
    }
    if (newRouteFunction) {
        routeFunction = newRouteFunction;
    }
}
exports.initialize = initialize;
function clearAuthData() {
    if (!dontTouchLocalStorage) {
        localStorage.removeItem(config.AUTH_DATA);
    }
}
function getAuthData() {
    var authDataString = localStorage.getItem(config.AUTH_DATA);
    var authData = authDataString ? JSON.parse(authDataString) : null;
    return authData;
}
function setAuthData(res) {
    if (!dontTouchLocalStorage) {
        localStorage.setItem(config.AUTH_DATA, res);
    }
}

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNvLWF1dGhlci9jby1hdXRoZXIudHMiXSwibmFtZXMiOlsiYmFzaWNSb3V0aW5nIiwiYWN0aXZhdGlvbkhlbHBlciIsInNldFRlcm1pbmFsIiwiZ29Ub1Rlcm1pbmFsIiwiQ29BdXRoZXIiLCJDb0F1dGhlci5pc0luaXRpYWxEYXRhTG9hZGVkIiwiQ29BdXRoZXIubG9naW5XcmFwIiwiQ29BdXRoZXIubG9nb3V0V3JhcCIsIkNvQXV0aGVyLm1ha2VJbml0aWFsUmVxdWVzdFdyYXAiLCJpbml0aWFsaXplIiwiY2xlYXJBdXRoRGF0YSIsImdldEF1dGhEYXRhIiwic2V0QXV0aERhdGEiXSwibWFwcGluZ3MiOiJBQUFBLElBQUkscUJBQXFCLEdBQUcsS0FBSyxDQUFBO0FBQ2pDLElBQUksYUFBYSxHQUFHLElBQUksQ0FBQTtBQUN4QixJQUFJLG9CQUFvQixHQUFHLEtBQUssQ0FBQTtBQUNoQyxJQUFJLFFBQVEsQ0FBQTtBQUNaLHNCQUF1QixTQUFTO0lBQzlCQSxJQUFJQSxHQUFHQSxHQUFHQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFBQTtJQUN6QkEsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsR0FBTUEsR0FBR0EsQ0FBQ0EsUUFBUUEsVUFBS0EsR0FBR0EsQ0FBQ0EsSUFBSUEsR0FBR0EsR0FBR0EsQ0FBQ0EsUUFBUUEsVUFBS0EsU0FBV0EsQ0FBQUE7QUFDcEZBLENBQUNBO0FBQ0QscURBQXFEO0FBQ3JELElBQUksYUFBYSxHQUFHLFVBQUMsU0FBUztJQUM1QixZQUFZLENBQUMsU0FBUyxDQUFDLENBQUE7QUFDekIsQ0FBQyxDQUFBO0FBQ0QsSUFBSSxXQUFXLEdBQUc7SUFDaEIsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ2QsTUFBTSx1Q0FBdUMsQ0FBQTtJQUMvQyxDQUFDO0lBQUMsSUFBSSxDQUFDLENBQUM7UUFDTixNQUFNLENBQUMsUUFBUSxDQUFBO0lBQ2pCLENBQUM7QUFDSCxDQUFDO0FBcUpDLG1CQUFXLGVBckpaO0FBRUQsSUFBSSxNQUFNLEdBQUc7SUFDWCxTQUFTLEVBQUUsVUFBVTtJQUNyQixZQUFZLEVBQUUsY0FBYztJQUM1QixlQUFlLEVBQUUsZ0JBQWdCO0lBQ2pDLFNBQVMsRUFBRSxVQUFVO0NBQ3RCLENBQUE7QUFFRCwwQ0FBMEM7QUFDMUMsSUFBSSxxQkFBcUIsR0FBRyxLQUFLLENBQUE7QUFDakMsMEJBQTJCLFdBQVc7SUFDcENDLElBQUlBLFdBQVdBLEdBQUdBLEtBQUtBLENBQUFBO0lBQ3ZCQSxJQUFJQSxnQkFBZ0JBLEdBQUdBLElBQUlBLENBQUFBO0lBQzNCQSxJQUFJQSxRQUFRQSxHQUFHQSxXQUFXQSxFQUFFQSxDQUFDQSxXQUFXQSxFQUFFQSxDQUFBQTtJQUMxQ0EsSUFBSUEsaUJBQWlCQSxHQUFHQSxXQUFXQSxFQUFFQSxDQUFDQSxtQkFBbUJBLEVBQUVBLENBQUFBO0lBQzNEQSxFQUFFQSxDQUFDQSxDQUFDQSxRQUFRQSxJQUFJQSxpQkFBaUJBLENBQUNBLENBQUNBLENBQUNBO1FBQ2xDQSxzREFBc0RBO1FBQ3REQSxnQkFBZ0JBLEdBQUdBLE1BQU1BLENBQUNBLFNBQVNBLENBQUFBO1FBQ25DQSxXQUFXQSxHQUFHQSxXQUFXQSxLQUFLQSxnQkFBZ0JBLENBQUFBO0lBQ2hEQSxDQUFDQTtJQUFDQSxJQUFJQSxDQUFDQSxFQUFFQSxDQUFDQSxDQUFDQSxDQUFDQSxRQUFRQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNyQkEsZ0JBQWdCQSxHQUFHQSxNQUFNQSxDQUFDQSxZQUFZQSxDQUFBQTtRQUN0Q0EsV0FBV0EsR0FBR0EsV0FBV0EsS0FBS0EsZ0JBQWdCQSxDQUFBQTtJQUNoREEsQ0FBQ0E7SUFBQ0EsSUFBSUEsQ0FBQ0EsQ0FBQ0E7UUFDTkEsZ0JBQWdCQSxHQUFHQSxNQUFNQSxDQUFDQSxlQUFlQSxDQUFBQTtRQUN6Q0EsV0FBV0EsR0FBR0EsV0FBV0EsS0FBS0EsZ0JBQWdCQSxDQUFBQTtRQUM5Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EscUJBQXFCQSxJQUFJQSxDQUFDQSxvQkFBb0JBLENBQUNBLENBQUNBLENBQUNBO1lBQ3BEQSxxQkFBcUJBLEdBQUdBLElBQUlBLENBQUFBO1lBQzVCQSxXQUFXQSxFQUFFQSxDQUFDQSxzQkFBc0JBLEVBQUVBO2lCQUNuQ0EsSUFBSUEsQ0FBQ0E7Z0JBQ0pBLHFCQUFxQkEsR0FBR0EsS0FBS0EsQ0FBQUE7Z0JBQzdCQSw0Q0FBNENBO2dCQUM1Q0EsRUFBRUEsQ0FBQ0EsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7b0JBQ2xCQSxNQUFNQSxDQUFDQSxZQUFZQSxFQUFFQSxDQUFBQTtnQkFDdkJBLENBQUNBO2dCQUNEQSxNQUFNQSxDQUFDQSxhQUFhQSxDQUFDQSxNQUFNQSxDQUFDQSxTQUFTQSxDQUFDQSxDQUFBQTtZQUN4Q0EsQ0FBQ0EsQ0FBQ0E7aUJBQ0RBLEtBQUtBLENBQUNBO2dCQUNMQSw0RUFBNEVBO2dCQUM1RUEscUJBQXFCQSxHQUFHQSxLQUFLQSxDQUFBQTtnQkFDN0JBLG9CQUFvQkEsR0FBR0EsSUFBSUEsQ0FBQUE7Z0JBQzNCQSxhQUFhQSxFQUFFQSxDQUFBQTtnQkFDZkEsTUFBTUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQUE7WUFDM0NBLENBQUNBLENBQUNBLENBQUFBO1FBQ05BLENBQUNBO1FBQUNBLElBQUlBLENBQUNBLEVBQUVBLENBQUNBLENBQUNBLG9CQUFvQkEsSUFBSUEsUUFBUUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFFNUNBLE9BQU9BLENBQUNBLEtBQUtBLENBQUNBLGtJQUFrSUEsQ0FBQ0EsQ0FBQUE7UUFDbkpBLENBQUNBO0lBQ0hBLENBQUNBO0lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLENBQUNBLFdBQVdBLENBQUNBLENBQUNBLENBQUNBO1FBQ2pCQSxNQUFNQSxDQUFDQSxhQUFhQSxDQUFDQSxnQkFBZ0JBLENBQUNBLENBQUFBO0lBQ3hDQSxDQUFDQTtJQUNEQSxNQUFNQSxDQUFDQSxXQUFXQSxDQUFBQTtBQUNwQkEsQ0FBQ0E7QUFpR0Msd0JBQWdCLG9CQWpHakI7QUFFRCxrQkFBa0I7QUFDbEI7SUFDRUMsYUFBYUEsR0FBR0EsTUFBTUEsQ0FBQ0EsUUFBUUEsQ0FBQ0EsSUFBSUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7SUFDakRBLE1BQU1BLENBQUNBLElBQUlBLENBQUFBO0FBQ2JBLENBQUNBO0FBNEZDLG1CQUFXLGVBNUZaO0FBQ0Q7SUFDRUMsWUFBWUEsQ0FBQ0EsYUFBYUEsQ0FBQ0EsQ0FBQUE7QUFDN0JBLENBQUNBO0FBRUQsa0JBQW1CLFVBQVU7SUFDM0JDLElBQUlBLGlCQUFpQkEsR0FBR0EsS0FBS0EsQ0FBQUE7SUFDN0JBO1FBQ0VDLE1BQU1BLENBQUNBLGlCQUFpQkEsQ0FBQUE7SUFDMUJBLENBQUNBO0lBQ0RELElBQUlBLGlCQUFpQkEsQ0FBQUE7SUFFckJBO1FBQW9CRSxjQUFPQTthQUFQQSxXQUFPQSxDQUFQQSxzQkFBT0EsQ0FBUEEsSUFBT0E7WUFBUEEsNkJBQU9BOztRQUN6QkEsb0JBQW9CQSxHQUFHQSxLQUFLQSxDQUFBQSxDQUFDQSxpQkFBaUJBO1FBQzlDQSxNQUFNQSxDQUFDQSxVQUFVQSxDQUFDQSxLQUFLQSxDQUFDQSxLQUFLQSxDQUFDQSxVQUFVQSxFQUFFQSxJQUFJQSxDQUFDQTthQUM1Q0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsR0FBR0E7WUFDUkEsZ0RBQWdEQTtZQUNoREEsV0FBV0EsQ0FBQ0EsR0FBR0EsQ0FBQ0EsQ0FBQUE7WUFDaEJBLGFBQWFBLENBQUNBLE1BQU1BLENBQUNBLGVBQWVBLENBQUNBLENBQUFBO1FBQ3ZDQSxDQUFDQSxDQUFDQSxDQUFBQTtJQUNOQSxDQUFDQTtJQUVERjtRQUFxQkcsY0FBT0E7YUFBUEEsV0FBT0EsQ0FBUEEsc0JBQU9BLENBQVBBLElBQU9BO1lBQVBBLDZCQUFPQTs7UUFDMUJBLE1BQU1BLENBQUNBLFVBQVVBLENBQUNBLE1BQU1BLENBQUNBLEtBQUtBLENBQUNBLFVBQVVBLEVBQUVBLElBQUlBLENBQUNBO2FBQzdDQSxJQUFJQSxDQUFDQTtZQUNKQSxhQUFhQSxFQUFFQSxDQUFBQTtRQUNqQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7SUFDTkEsQ0FBQ0E7SUFFREg7UUFDRUksTUFBTUEsQ0FBQ0EsVUFBVUEsQ0FBQ0Esa0JBQWtCQSxFQUFFQTthQUNuQ0EsSUFBSUEsQ0FBQ0EsVUFBQ0EsSUFBSUE7WUFDVEEsdUJBQXVCQTtZQUN2QkEsaUJBQWlCQSxHQUFHQSxJQUFJQSxDQUFBQTtRQUMxQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQUE7SUFDTkEsQ0FBQ0E7SUFFREosTUFBTUEsQ0FBQ0E7UUFDTEEsV0FBQUEsU0FBU0E7UUFDVEEsWUFBQUEsVUFBVUE7UUFDVkEsd0JBQUFBLHNCQUFzQkE7UUFDdEJBLGFBQUFBLFdBQVdBO1FBQ1hBLHFCQUFBQSxtQkFBbUJBO0tBQ3BCQSxDQUFBQTtBQUNIQSxDQUFDQTtBQUVELG9CQUFxQixVQUFVLEVBQUUsU0FBUyxFQUFFLGdCQUFnQjtJQUMxREssUUFBUUEsR0FBR0EsUUFBUUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsQ0FBQUE7SUFDL0JBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO1FBQ3ZCQSxNQUFNQSxDQUFDQSxTQUFTQSxHQUFHQSxTQUFTQSxDQUFDQSxRQUFRQSxDQUFBQTtJQUN2Q0EsQ0FBQ0E7SUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EscUJBQXFCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUNwQ0EscUJBQXFCQSxHQUFHQSxJQUFJQSxDQUFBQTtJQUM5QkEsQ0FBQ0E7SUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDckJBLEVBQUVBLENBQUNBLENBQUNBLFNBQVNBLENBQUNBLE1BQU1BLENBQUNBLFFBQVFBLENBQUNBLENBQUNBLENBQUNBO1lBQzlCQSxNQUFNQSxDQUFDQSxTQUFTQSxHQUFHQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFBQTtRQUM5Q0EsQ0FBQ0E7UUFDREEsRUFBRUEsQ0FBQ0EsQ0FBQ0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsWUFBWUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7WUFDbENBLE1BQU1BLENBQUNBLFlBQVlBLEdBQUdBLFNBQVNBLENBQUNBLE1BQU1BLENBQUNBLFlBQVlBLENBQUFBO1FBQ3JEQSxDQUFDQTtRQUNEQSxFQUFFQSxDQUFDQSxDQUFDQSxTQUFTQSxDQUFDQSxNQUFNQSxDQUFDQSxjQUFjQSxDQUFDQSxDQUFDQSxDQUFDQTtZQUNwQ0EsTUFBTUEsQ0FBQ0EsZUFBZUEsR0FBR0EsU0FBU0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsY0FBY0EsQ0FBQUE7UUFDMURBLENBQUNBO0lBQ0hBLENBQUNBO0lBQ0RBLEVBQUVBLENBQUNBLENBQUNBLGdCQUFnQkEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0E7UUFDckJBLGFBQWFBLEdBQUdBLGdCQUFnQkEsQ0FBQUE7SUFDbENBLENBQUNBO0FBQ0hBLENBQUNBO0FBcUJDLGtCQUFVLGNBckJYO0FBRUQ7SUFDRUMsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EscUJBQXFCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMzQkEsWUFBWUEsQ0FBQ0EsVUFBVUEsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQUE7SUFDM0NBLENBQUNBO0FBQ0hBLENBQUNBO0FBRUQ7SUFDRUMsSUFBSUEsY0FBY0EsR0FBR0EsWUFBWUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsQ0FBQ0EsQ0FBQUE7SUFDM0RBLElBQUlBLFFBQVFBLEdBQUdBLGNBQWNBLEdBQUdBLElBQUlBLENBQUNBLEtBQUtBLENBQUNBLGNBQWNBLENBQUNBLEdBQUdBLElBQUlBLENBQUFBO0lBQ2pFQSxNQUFNQSxDQUFDQSxRQUFRQSxDQUFBQTtBQUNqQkEsQ0FBQ0E7QUFFRCxxQkFBc0IsR0FBRztJQUN2QkMsRUFBRUEsQ0FBQ0EsQ0FBQ0EsQ0FBQ0EscUJBQXFCQSxDQUFDQSxDQUFDQSxDQUFDQTtRQUMzQkEsWUFBWUEsQ0FBQ0EsT0FBT0EsQ0FBQ0EsTUFBTUEsQ0FBQ0EsU0FBU0EsRUFBRUEsR0FBR0EsQ0FBQ0EsQ0FBQUE7SUFDN0NBLENBQUNBO0FBQ0hBLENBQUNBO0FBT0EiLCJmaWxlIjoiY28tYXV0aGVyL2NvLWF1dGhlci5qcyIsInNvdXJjZXNDb250ZW50IjpbImxldCBkb250VG91Y2hMb2NhbFN0b3JhZ2UgPSBmYWxzZVxubGV0IHRlcm1pbmFsUm91dGUgPSBudWxsXG5sZXQgaW5pdGlhbFJlcXVlc3RGYWlsZWQgPSBmYWxzZVxubGV0IGNvQXV0aGVyXG5mdW5jdGlvbiBiYXNpY1JvdXRpbmcgKGFmdGVySGFzaCkge1xuICBsZXQgbG9jID0gd2luZG93LmxvY2F0aW9uXG4gIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gYCR7bG9jLnByb3RvY29sfS8vJHtsb2MuaG9zdH0ke2xvYy5wYXRobmFtZX0jLyR7YWZ0ZXJIYXNofWBcbn1cbi8vIEJhc2ljIGRlZmF1bHQgcm91dGUgZnVuY3Rpb24sIHNob3VsZCBiZSBvdmVycmlkZGVuXG5sZXQgcm91dGVGdW5jdGlvbiA9IChhZnRlckhhc2gpID0+IHtcbiAgYmFzaWNSb3V0aW5nKGFmdGVySGFzaClcbn1cbmxldCBnZXRDb0F1dGhlciA9IGZ1bmN0aW9uICgpIHtcbiAgaWYgKCFjb0F1dGhlcikge1xuICAgIHRocm93ICdDb0F1dGhlciBoYXMgbm90IGJlZW4gaW5pdGlhbGl6ZWQgeWV0J1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBjb0F1dGhlclxuICB9XG59XG5cbmxldCBjb25maWcgPSB7XG4gIExPR0dFRF9JTjogJ2xvZ2dlZEluJyxcbiAgQVVUSEVOVElDQVRFOiAnYXV0aGVudGljYXRlJyxcbiAgSU5JVElBTF9SRVFVRVNUOiAnaW5pdGlhbFJlcXVlc3QnLFxuICBBVVRIX0RBVEE6ICdhdXRoRGF0YSdcbn1cblxuLy8gRGV0ZXJtaW5lIGlmIGEgcm91dGUgY2FuQWN0aXZhdGUgb3Igbm90XG52YXIgaW5pdGlhbFJlcXVlc3RQZW5kaW5nID0gZmFsc2VcbmZ1bmN0aW9uIGFjdGl2YXRpb25IZWxwZXIgKGN1cnJlbnRQYWdlKTogYW55IHtcbiAgbGV0IGNhbkFjdGl2YXRlID0gZmFsc2VcbiAgbGV0IGRlc3RpbmF0aW9uUm91dGUgPSBudWxsXG4gIGxldCBhdXRoRGF0YSA9IGdldENvQXV0aGVyKCkuZ2V0QXV0aERhdGEoKVxuICBsZXQgaW5pdGlhbERhdGFMb2FkZWQgPSBnZXRDb0F1dGhlcigpLmlzSW5pdGlhbERhdGFMb2FkZWQoKVxuICBpZiAoYXV0aERhdGEgJiYgaW5pdGlhbERhdGFMb2FkZWQpIHtcbiAgICAvLyBhdXRoRGF0YSBhbmQgaW5pdGlhbFJlcXVlc3QgZG9uZSwgeW91IGFyZSBsb2dnZWQgaW5cbiAgICBkZXN0aW5hdGlvblJvdXRlID0gY29uZmlnLkxPR0dFRF9JTlxuICAgIGNhbkFjdGl2YXRlID0gY3VycmVudFBhZ2UgPT09IGRlc3RpbmF0aW9uUm91dGVcbiAgfSBlbHNlIGlmICghYXV0aERhdGEpIHtcbiAgICBkZXN0aW5hdGlvblJvdXRlID0gY29uZmlnLkFVVEhFTlRJQ0FURVxuICAgIGNhbkFjdGl2YXRlID0gY3VycmVudFBhZ2UgPT09IGRlc3RpbmF0aW9uUm91dGVcbiAgfSBlbHNlIHtcbiAgICBkZXN0aW5hdGlvblJvdXRlID0gY29uZmlnLklOSVRJQUxfUkVRVUVTVFxuICAgIGNhbkFjdGl2YXRlID0gY3VycmVudFBhZ2UgPT09IGRlc3RpbmF0aW9uUm91dGVcbiAgICBpZiAoIWluaXRpYWxSZXF1ZXN0UGVuZGluZyAmJiAhaW5pdGlhbFJlcXVlc3RGYWlsZWQpIHtcbiAgICAgIGluaXRpYWxSZXF1ZXN0UGVuZGluZyA9IHRydWVcbiAgICAgIGdldENvQXV0aGVyKCkubWFrZUluaXRpYWxSZXF1ZXN0V3JhcCgpXG4gICAgICAgIC50aGVuKCgpID0+IHtcbiAgICAgICAgICBpbml0aWFsUmVxdWVzdFBlbmRpbmcgPSBmYWxzZVxuICAgICAgICAgIC8vIGluaXRpYWxSZXF1ZXN0IGRvbmUsIG1vdmUgb24gdG8gbG9nZ2VkIGluXG4gICAgICAgICAgaWYgKHRlcm1pbmFsUm91dGUpIHtcbiAgICAgICAgICAgIHJldHVybiBnb1RvVGVybWluYWwoKVxuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gcm91dGVGdW5jdGlvbihjb25maWcuTE9HR0VEX0lOKVxuICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKCkgPT4ge1xuICAgICAgICAgIC8vIGluaXRpYWwgcmVxdWVzdCBmYWlsZWQsIGNsZWFyIGF1dGggZGF0YSBmcm9tIGxvZ2luIGFuZCBnbyB0byBhdXRoZW50aWNhdGVcbiAgICAgICAgICBpbml0aWFsUmVxdWVzdFBlbmRpbmcgPSBmYWxzZVxuICAgICAgICAgIGluaXRpYWxSZXF1ZXN0RmFpbGVkID0gdHJ1ZVxuICAgICAgICAgIGNsZWFyQXV0aERhdGEoKVxuICAgICAgICAgIHJldHVybiByb3V0ZUZ1bmN0aW9uKGNvbmZpZy5BVVRIRU5USUNBVEUpXG4gICAgICAgIH0pXG4gICAgfSBlbHNlIGlmIChpbml0aWFsUmVxdWVzdEZhaWxlZCAmJiBhdXRoRGF0YSkge1xuXG4gICAgICBjb25zb2xlLmVycm9yKCdJbml0aWFsIHJlcXVlc3QgcHJvbWlzZSB3YXMgcmVqZWN0ZWQuIFlvdSBoYXZlIG1hbnVhbCBhdXRoRGF0YSBtYW5hZ2VtZW50IGFuZCBuZWVkIHRvIGNsZWFyIGF1dGhEYXRhIGZyb20gbG9jYWxTdG9yYWdlIG1hbnVhbGx5LicpXG4gICAgfVxuICB9XG4gIGlmICghY2FuQWN0aXZhdGUpIHtcbiAgICByZXR1cm4gcm91dGVGdW5jdGlvbihkZXN0aW5hdGlvblJvdXRlKVxuICB9XG4gIHJldHVybiBjYW5BY3RpdmF0ZVxufVxuXG4vLyB0ZXJtaW5hbCBtZW1vcnlcbmZ1bmN0aW9uIHNldFRlcm1pbmFsICgpIHtcbiAgdGVybWluYWxSb3V0ZSA9IHdpbmRvdy5sb2NhdGlvbi5oYXNoLnN1YnN0cmluZygyKVxuICByZXR1cm4gdHJ1ZVxufVxuZnVuY3Rpb24gZ29Ub1Rlcm1pbmFsICgpIHtcbiAgYmFzaWNSb3V0aW5nKHRlcm1pbmFsUm91dGUpXG59XG5cbmZ1bmN0aW9uIENvQXV0aGVyIChhcGlTZXJ2aWNlKSB7XG4gIGxldCBpbml0aWFsRGF0YUxvYWRlZCA9IGZhbHNlXG4gIGZ1bmN0aW9uIGlzSW5pdGlhbERhdGFMb2FkZWQgKCkge1xuICAgIHJldHVybiBpbml0aWFsRGF0YUxvYWRlZFxuICB9XG4gIGxldCBpbml0aWFsUmVxdWVzdFJlc1xuXG4gIGZ1bmN0aW9uIGxvZ2luV3JhcCAoLi4uYXJncykge1xuICAgIGluaXRpYWxSZXF1ZXN0RmFpbGVkID0gZmFsc2UgLy8gcmVzZXQgdGhpcyBvbmVcbiAgICByZXR1cm4gYXBpU2VydmljZS5sb2dpbi5hcHBseShhcGlTZXJ2aWNlLCBhcmdzKVxuICAgICAgLnRoZW4oKHJlcykgPT4ge1xuICAgICAgICAvLyBhdXRoRGF0YSBoYXMgYXJyaXZlZCwgZ28gbWFrZSBpbml0aWFsIHJlcXVlc3RcbiAgICAgICAgc2V0QXV0aERhdGEocmVzKVxuICAgICAgICByb3V0ZUZ1bmN0aW9uKGNvbmZpZy5JTklUSUFMX1JFUVVFU1QpXG4gICAgICB9KVxuICB9XG5cbiAgZnVuY3Rpb24gbG9nb3V0V3JhcCAoLi4uYXJncykge1xuICAgIHJldHVybiBhcGlTZXJ2aWNlLmxvZ291dC5hcHBseShhcGlTZXJ2aWNlLCBhcmdzKVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICBjbGVhckF1dGhEYXRhKClcbiAgICAgIH0pXG4gIH1cblxuICBmdW5jdGlvbiBtYWtlSW5pdGlhbFJlcXVlc3RXcmFwICgpIHtcbiAgICByZXR1cm4gYXBpU2VydmljZS5tYWtlSW5pdGlhbFJlcXVlc3QoKVxuICAgICAgLnRoZW4oKGRhdGEpID0+IHtcbiAgICAgICAgLy8gRmxhZyBmb3IgaW50aWFsIGRhdGFcbiAgICAgICAgaW5pdGlhbERhdGFMb2FkZWQgPSB0cnVlXG4gICAgICB9KVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBsb2dpbldyYXAsXG4gICAgbG9nb3V0V3JhcCxcbiAgICBtYWtlSW5pdGlhbFJlcXVlc3RXcmFwLFxuICAgIGdldEF1dGhEYXRhLFxuICAgIGlzSW5pdGlhbERhdGFMb2FkZWRcbiAgfVxufVxuXG5mdW5jdGlvbiBpbml0aWFsaXplIChhcGlTZXJ2aWNlLCBuZXdDb25maWcsIG5ld1JvdXRlRnVuY3Rpb24pIHtcbiAgY29BdXRoZXIgPSBDb0F1dGhlcihhcGlTZXJ2aWNlKVxuICBpZiAobmV3Q29uZmlnLmF1dGhEYXRhKSB7XG4gICAgY29uZmlnLkFVVEhfREFUQSA9IG5ld0NvbmZpZy5hdXRoRGF0YVxuICB9XG4gIGlmIChuZXdDb25maWcuZG9udFRvdWNoTG9jYWxTdG9yYWdlKSB7XG4gICAgZG9udFRvdWNoTG9jYWxTdG9yYWdlID0gdHJ1ZVxuICB9XG4gIGlmIChuZXdDb25maWcucm91dGVzKSB7XG4gICAgaWYgKG5ld0NvbmZpZy5yb3V0ZXMubG9nZ2VkSW4pIHtcbiAgICAgIGNvbmZpZy5MT0dHRURfSU4gPSBuZXdDb25maWcucm91dGVzLmxvZ2dlZEluXG4gICAgfVxuICAgIGlmIChuZXdDb25maWcucm91dGVzLmF1dGhlbnRpY2F0ZSkge1xuICAgICAgY29uZmlnLkFVVEhFTlRJQ0FURSA9IG5ld0NvbmZpZy5yb3V0ZXMuYXV0aGVudGljYXRlXG4gICAgfVxuICAgIGlmIChuZXdDb25maWcucm91dGVzLmluaXRpYWxSZXF1ZXN0KSB7XG4gICAgICBjb25maWcuSU5JVElBTF9SRVFVRVNUID0gbmV3Q29uZmlnLnJvdXRlcy5pbml0aWFsUmVxdWVzdFxuICAgIH1cbiAgfVxuICBpZiAobmV3Um91dGVGdW5jdGlvbikge1xuICAgIHJvdXRlRnVuY3Rpb24gPSBuZXdSb3V0ZUZ1bmN0aW9uXG4gIH1cbn1cblxuZnVuY3Rpb24gY2xlYXJBdXRoRGF0YSAoKSB7XG4gIGlmICghZG9udFRvdWNoTG9jYWxTdG9yYWdlKSB7XG4gICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oY29uZmlnLkFVVEhfREFUQSlcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRBdXRoRGF0YSAoKSB7XG4gIGxldCBhdXRoRGF0YVN0cmluZyA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGNvbmZpZy5BVVRIX0RBVEEpXG4gIGxldCBhdXRoRGF0YSA9IGF1dGhEYXRhU3RyaW5nID8gSlNPTi5wYXJzZShhdXRoRGF0YVN0cmluZykgOiBudWxsXG4gIHJldHVybiBhdXRoRGF0YVxufVxuXG5mdW5jdGlvbiBzZXRBdXRoRGF0YSAocmVzKSB7XG4gIGlmICghZG9udFRvdWNoTG9jYWxTdG9yYWdlKSB7XG4gICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oY29uZmlnLkFVVEhfREFUQSwgcmVzKVxuICB9XG59XG5cbmV4cG9ydCB7XG4gIGluaXRpYWxpemUsXG4gIGdldENvQXV0aGVyLFxuICBhY3RpdmF0aW9uSGVscGVyLFxuICBzZXRUZXJtaW5hbFxufVxuIl0sInNvdXJjZVJvb3QiOiIvbm9kZV9tb2R1bGVzIn0=
